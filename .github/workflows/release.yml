name: Attach TAR.GZ files to release

on:
  push:
    tags:
      - "*"

jobs:
  upload-assets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # Testmodus: Dummy-5MB-tar.gz erzeugen (nur bei dispatch)
      # ---------------------------------------------------------
      - name: Create dummy tar.gz for testing
        #if: github.event_name == 'workflow_dispatch'
        run: |
          echo "Erzeuge Dummy-Datei (5 MB)…"
          # 5 MB Raw-Datei
          dd if=/dev/zero of=dummy.bin bs=1M count=5
          # tar.gz erzeugen
          tar -czf test.tar.gz dummy.bin
          rm dummy.bin
          echo "Dummy-Datei test.tar.gz erzeugt."

      # ---------------------------------------------------------
      # Dateien finden (egal ob Release oder Test)
      # ---------------------------------------------------------
      - name: Find .tar.gz files
        id: find_files
        run: |
          files=$(find . -type f -name "*.tar.gz")
          if [ -z "$files" ]; then
            echo "Keine .tar.gz-Dateien gefunden."
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "Gefundene Dateien:"
            echo "$files"
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$files" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # Upload nur bei echten Releases
      # ---------------------------------------------------------
      - name: Upload each .tar.gz to release
        if: steps.find_files.outputs.files != ''
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.find_files.outputs.files }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------
      # Dateien löschen
      # ---------------------------------------------------------
      - name: Delete .tar.gz after upload or test
        if: steps.find_files.outputs.files != ''
        run: |
          echo "${{ steps.find_files.outputs.files }}" | xargs rm -f
          echo "Dateien gelöscht."
